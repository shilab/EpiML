<!DOCTYPE html>
{% extends "base.html" %}
{% block title %}
    <title>Result | Shilab web server</title>
{% endblock %}
{% block styles %}
    {{ super() }}
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.css">
    <link rel="stylesheet" type="text/css"
          href="https://cdn.datatables.net/v/dt/dt-1.10.16/sl-1.2.5/datatables.min.css">
    <link rel="stylesheet" type="text/css"
          href="{{ url_for('static',filename='css/vis_miRNA_HEB.css') }}">
    <link rel="stylesheet" type="text/css"
          href="{{ url_for('static',filename='css/vis_miRNA_FD.css') }}">
    <link rel="stylesheet" type="text/css"
          href="{{ url_for('static',filename='css/vis_AM.css') }}">
    <style>
        .table-hover tbody tr:hover td, .table-hover tbody tr:hover th {
            background-color: coral;
        }

        [id|='FD_diagram'] {
            border: 1px solid black;
        }


    </style>

{% endblock %}
{% block scripts %}
    {{ super() }}
    <!-- for datatables -->
    <script type="text/javascript" charset="utf8"
            src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" charset="utf8"
            src="https://cdn.datatables.net/v/dt/dt-1.10.16/sl-1.2.5/datatables.min.js"></script>
    <script>
        function selectRowHighLightLink(row) {

            HEB_node
                .each(function (n) {
                    n.target = n.source = false;
                });

            HEB_link
                .classed("HEB_link--target", function (l) {

                    if (l.target.data.key === row.data()[2]) return l.source.source = true;
                })
                .classed("HEB_link--source", function (l) {
                    if (l.source.data.key === row.data()[1]) return l.target.target = true;
                })
                .filter(function (l) {
                    return l.target.data.key === row.data()[2] || l.source.data.key === row.data()[1];
                })
                .raise();

            HEB_node
                .classed("HEB_node--target", function (n) {
                    return n.target;
                })
                .classed("HEB_node--source", function (n) {
                    return n.source;
                });

        }

        $(document).ready(function () {
            $('#main_effect').DataTable();

            var epis_table = $('#epis_effect').DataTable();

            $('#epis_effect tbody').on('click', 'tr', function () {
                if ($(this).hasClass('selected')) {
                    $(this).removeClass('selected');
                }
                else {
                    epis_table.$('tr.selected').removeClass('selected');
                    $(this).addClass('selected');
                }

                selectRowHighLightLink(epis_table.row('.selected'));

            });
        });

    </script>

    <script src="https://d3js.org/d3.v4.min.js"></script>
    <!-- for save as -->
    <script src="{{ url_for('static',filename='js/saveSvgAsPng.js') }}"></script>
    <script src="https://cdn.rawgit.com/eligrey/canvas-toBlob.js/f1a01896135ab378aa5c0118eadd81da55e698d8/canvas-toBlob.js"></script>
    <script src="https://cdn.rawgit.com/eligrey/FileSaver.js/e9d941381475b5df8b7d7691013401e171014e89/FileSaver.min.js"></script>

{% endblock %}

{% block content %}
    <div>
        <h2>Results</h2>
        <hr>
        <p>Your job is finished, and the results are shown in following. Result can be downloaded
            <a href="{{ url_for('download_result',jobid=jobid, filename='EBEN.main_result.txt') }}" target="_blank">Main
                effect</a>,
            <a href="{{ url_for('download_result',jobid=jobid, filename='EBEN.epis_result.txt') }}" target="_blank">Epistatic
                effect</a>
        </p>

        <div class="container">
            <section>
                <h3>Main Effect</h3>
                <div>
                    <table id="main_effect" name="main_effect" class="table table-hover stripe">
                        <thead>
                        <tr>
                            <th>#</th>
                            <th>Feature</th>
                            <th>Coefficent value</th>
                            <th>Posterior variance</th>
                            <th>t-value</th>
                            <th>p-value</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for line in EBEN_main_result %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ line[0] }}</td>
                                <td>{{ line[1] }}</td>
                                <td>{{ line[2] }}</td>
                                <td>{{ line[3] }}</td>
                                <td>{{ line[4] }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>
            <section>
                <h3>Epistatic Effect</h3>
                <div>
                    <table id="epis_effect" name="epis_effect" class="table table-hover stripe ">
                        <thead>
                        <tr>
                            <th>#</th>
                            <th>Feature 1</th>
                            <th>Feature 2</th>
                            <th>Coefficent value</th>
                            <th>Posterior variance</th>
                            <th>t-value</th>
                            <th>p-value</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for line in EBEN_epis_result %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ line[0] }}</td>
                                <td>{{ line[1] }}</td>
                                <td>{{ line[2] }}</td>
                                <td>{{ line[3] }}</td>
                                <td>{{ line[4] }}</td>
                                <td>{{ line[5] }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>
            <section>
                <h3>Circle Network</h3>
                <p> A circle network shows the interactions between epistatic features.
                </p>

                <div class="row" style="padding: 10px">
                    <div class="col-sm-3">
                        <p style="font-size: medium">
                            Mouseover any of nodes in this network to see its <span style="color: #d62728;">associative features in red</span>.
                        </p>
                        <p style="font-size: medium">
                            Click one node to find details in above Epistatic Effect table. Double click on graph back
                            to default.
                        </p>

                        <!--//TODO: add datatables mouseover events -->
                        <p></p>
                        <div>
                            <button id='HEB_saveAsPNG' style="margin: 10px">Save as PNG</button>
                            <button id='HEB_saveAsSVG' style="margin: 10px">Save as SVG</button>
                        </div>
                    </div>

                    <div id="HEB_canvas" class="col-sm-9" align="center">
                        <svg name="HEB_diagram" id="HEB_diagram"></svg>
                    </div>
                    <!-- for hierarchical edge bundling graph -->
                    <script>
                        var miRNA_HEB_json = {{ miRNA_HEB_json|safe }};
                    </script>
                    <script type="text/javascript" charset="utf8"
                            src="{{ url_for('static', filename='js/vis_miRNA_HEB_d3.js') }}">
                    </script>
                </div>

            </section>
            <section>
                <h3>Adjacency Matrix</h3>
                <div>
                    <p> A network can be represented by an adjacency matrix, where each cell (<i>i</i>, <i>j</i>)
                        represents an
                        edge from vertex <i>i</i> to vertex <i>j</i>. Here, vertices represent features in epistatic
                        effect, while
                        edges represent coefficient value.</p>
                    <p> While network diagram can give a good view for node-link relationship, adjacency matrix diagram
                        has other advantages. As networks get large and highly connected, diagrams
                        often devolve into giant hairballs of line crossings. Line crossings are impossible with
                        matrix views. Matrix cells can also be encoded to show additional data.
                    </p>
                    <!-- <p>add adjacent matrix. There is an example: https://bost.ocks.org/mike/miserables/</p>-->
                </div>
                <div class="row" style="padding: 10px">
                    <div class="col-sm-2">
                        <aside>
                            <p style="font-size: medium;">
                                Matrix cell depicts coefficent value in epistatic effect table.
                            </p>
                            <p style="font-size: medium;">
                                Blue cells indicate positive value, and purple cells indicate negative value. The darker
                                cells indicate strong interaction.
                            </p>
                            <p style="font-size: medium">
                                Use the drop-down menu to reorder the matrix and explore the data.
                            </p>
                            <p style="font-size: medium">Order: <select id="order">
                                <option value="name">by Name</option>
                                <option value="count">by Count</option>
                                <option value="rank">by Position</option>
                            </select>
                            </p>
                        </aside>
                    </div>
                    <div class="col-sm-offset-1 col-sm-8" id="vis_am" name="vis_am">
                        <svg id="adjacency_matrix" name="adjacency_matrix"></svg>
                    </div>
                    <script>
                        var am_graph_json = '{{ am_graph_json}}';
                    </script>
                    <script src="{{ url_for('static',filename='js/vis_AM.js') }}"></script>
                </div>
            </section>
            <section>
                <h3>External Resources</h3>
                <div id="visualization" class="container">
                    <p>Relationship between miRNAs and target genes. The mega data can be download
                        <a href="{{ url_for('download_result',jobid=jobid, filename='nodes_links.json') }}"
                           target="_blank">here</a> in
                        JSON format.</p>
                    <div class="row">
                        <div class=" col-sm-6">
                            <label><input type="checkbox" class="filter-ckb" value="Main effect" checked> Main
                                effect</label>
                            <label><input type="checkbox" class="filter-ckb" value="Epistatic effect" checked>
                                Epistatic effect</label>
                            <label> <input type="checkbox" class="filter-ckb" value="Target gene" checked> Target
                                gene</label>
                        </div>
                        <div class=" col-sm-6" align="right">
                            <button id='FD_saveAsPNG'>Save as PNG</button>
                            <button id='FD_saveAsSVG'>Save as SVG</button>
                        </div>
                    </div>
                    <div style="padding-top: 10px">
                        <svg name="FD_legend" id="FD_legend"></svg>
                        <svg name="FD_diagram" id="FD_diagram"></svg>
                    </div>
                    <!-- for d3 visualization.
                                This script must be after svg tag-->
                    <script>
                        var nodes_links_json = '{{ nodes_links_json }}';
                        var legends_json = '{{ legends_json }}';
                    </script>
                    <script type="text/javascript" charset="utf8"
                            src="{{ url_for('static', filename='js/vis_miRNA_FD_d3.js') }}"></script>
                    <script type="text/javascript" charset="utf8"
                            src="{{ url_for('static', filename='js/vis_miRNA_legend_d3.js') }}"></script>
                </div>
            </section>
        </div>
    </div>
{% endblock %}
